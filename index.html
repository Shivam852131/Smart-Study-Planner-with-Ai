<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Study Planner AI ‚Äî Full Auth (Fixed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#ee12b3;--bg2:#1446bc;--accent1:#3d0ee4;--accent2:#350f76;--glass:rgba(211, 208, 208, 0);--muted:#d2d4d7;--text:#e6eef8}
    *{box-sizing:border-box}body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:Inter,system-ui,Arial}
    .app{display:grid;grid-template-columns:260px 1fr;gap:18px;padding:20px;min-height:100vh}
    @media(max-width:900px){.app{grid-template-columns:1fr}}
    .sidebar{padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(68, 13, 164, 0.06),rgba(63, 162, 208, 0))}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800}
    .nav{margin-top:16px;display:flex;flex-direction:column;gap:8px}
    .nav button{background:transparent;border:none;color:var(--text);text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav button.active{background:var(--glass);transform:translateX(6px)}
    .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:rgb(240, 234, 234);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgb(241, 240, 244)}
    .content{display:flex;flex-direction:column;gap:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .search{display:flex;gap:8px;align-items:center;background:var(--glass);padding:10px;border-radius:10px;min-width:220px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}@media(max-width:700px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(249, 244, 244, 0.548),rgba(82, 25, 181, 0.658));padding:14px;border-radius:14px}
    input,select,textarea{padding:10px;border-radius:8px;border:none;background:rgba(23, 23, 23, 0.73);color:var(--text)}
    .task-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .task-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(67, 230, 8, 0)}
    .task-item.done{opacity:0.6;text-decoration:line-through}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .day{min-height:100px;padding:8px;border-radius:8px;background:rgba(37, 188, 10, 0)}
    .draggable{padding:6px;border-radius:8px;background:linear-gradient(90deg,var(--accent1),var(--accent2));cursor:grab;color:rgb(234, 227, 227);margin-bottom:6px}
    .chat-btn{width:56px;height:56px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:rgb(178, 172, 172);cursor:pointer;position:fixed;right:20px;bottom:20px;z-index:999}
    .chat-window{position:fixed;right:20px;bottom:88px;width:360px;border-radius:10px;background:linear-gradient(180deg,rgb(227, 7, 125),rgba(222, 18, 18, 0.904));box-shadow:0 18px 60px rgba(135, 7, 227, 0.6);z-index:999;display:none;flex-direction:column;overflow:hidden}
    .chat-header{display:flex;justify-content:space-between;align-items:center;padding:12px}
    .chat-body{padding:12px;height:320px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:78%;padding:10px;border-radius:12px}
    .bubble.user{align-self:flex-end;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:rgb(231, 228, 228)}
    .bubble.bot{align-self:flex-start;background:rgba(11, 11, 11, 0.825);color:var(--text)}
    .chat-input{display:flex;padding:10px;border-top:1px solid rgb(232, 214, 214)}
    .hint{font-size:13px;color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .admin-badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#111827;color:#fff;font-size:12px;margin-left:8px}
    a{color:inherit}
    .notes-controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .note-card .btn{margin-left:6px}
    .small{font-size:12px}

    /* NEW CSS FOR TEST PAGE */
    .topic-item-verify {
        padding: 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px;
        cursor: pointer;
    }
    .topic-item-verify.unverified {
        opacity: 0.5;
        background: rgba(255, 0, 0, 0.1);
    }
    .profile-info div {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo-box">
          <div class="logo">SS</div>
        </div>
        <div><div style="font-weight:800">Smart Study Planner AI</div><div class="hint">Plan ‚Ä¢ Track ‚Ä¢ Improve</div></div>
      </div>

      <nav class="nav" id="nav">
        <button data-page="home" class="active"> Home</button>
        <button data-page="tasks"> Tasks</button>
        <button data-page="goals"> Goals</button>
        <button data-page="assignments"> Assignments</button>
        <button data-page="schedule"> Schedule</button>
        <button data-page="notes"> Notes</button>
        <button data-page="test-page"> ü§ñ AI Test Page</button>
        <button data-page="analytics"> Analytics</button>
        <button data-page="chatbot"> Chatbot</button>
        <button data-page="admin" id="navAdmin" style="display:none">‚ú® Admin Panel</button>
        <button data-page="livechat" id="navLiveChat">üí¨ Live Chat</button>
        <button data-page="settings"> Settings</button>
        
        


      </nav>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="navLogin">Login</button>
        <button class="btn ghost" id="navSignup">Sign Up</button>
        <button class="btn ghost" id="navProfile">Profile</button>
      </div>

      <div style="margin-top:12px" class="hint"> </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="11" cy="11" r="5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <input id="globalSearch" placeholder="Search tasks, goals..." />
          </div>
          <div class="hint" id="userGreeting">Welcome To</div>
        </div>

        <div style="display:flex;gap:12px;align-items:center">
          <div id="roleDisplay" class="hint">Guest</div>
          <div id="avatar" style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700">S</div>
        </div>
      </div>

      <section id="pages">
        <!-- LIVE CHAT PAGE -->
<div class="page card" id="livechat" style="display:none">
  <h3>Live Chat</h3>

  <div style="display:flex;gap:12px">

    <!-- Conversation List -->
    <div style="width:30%;background:rgba(0,0,0,0.25);padding:12px;border-radius:8px">
      <h4>Chats</h4>
      <div id="chatUserList"></div>
    </div>

    <!-- Chat Window -->
    <div style="flex:1;background:rgba(0,0,0,0.15);border-radius:8px;padding:12px;display:flex;flex-direction:column">
      <div id="chatHeader" style="font-weight:700;margin-bottom:10px">Select a conversation</div>
      <div id="chatMessages" style="height:300px;overflow:auto;background:rgba(255,255,255,0.05);padding:10px;border-radius:6px"></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="chatInput" placeholder="Type message..." style="flex:1">
        <button class="btn" id="sendChatBtn">Send</button>
      </div>
    </div>

  </div>
</div>


        <div class="card page" id="login" style="display:none;max-width:520px;margin:12px auto">
          <h3>Login to your account</h3>
          <input id="loginEmail" placeholder="Email" type="email">
          <input id="loginPass" placeholder="Password" type="password">
          <div style="margin-top:10px"><button class="btn" id="loginBtn">Login</button></div>
          <div class="hint" style="margin-top:8px">New user? <a href="#" id="toSignup">Create an account</a></div>
          <div class="hint" style="margin-top:8px"><a href="#" id="forgotPass">Forgot password?</a></div>
          <!-- ADMIN / TEACHER PANEL -->
           <div class="page card" id="admin" style="display:none">
  <h3>Admin / Teacher Panel</h3>

  <div style="display:flex;gap:12px;flex-wrap:wrap">

    <!-- Create Task -->
    <div class="card" style="min-width:320px">
      <h4>Create Task for Students</h4>
      <input id="adminTaskTitle" placeholder="Task title">
      <input id="adminTaskSubject" placeholder="Subject">
      <input id="adminTaskXp" type="number" placeholder="XP reward" value="10">
      <label><input type="checkbox" id="adminAssignAll" checked> Assign to ALL students</label>
      <button class="btn" id="adminAddTask">Create Task</button>
    </div>

    <!-- Create Assignment -->
    <div class="card" style="min-width:320px">
      <h4>Create Assignment</h4>
      <input id="adminAssignTitle" placeholder="Assignment title">
      <input id="adminAssignDue" type="date">
      <input id="adminAssignXp" type="number" placeholder="XP reward" value="30">
      <label>Assign to student (optional): <select id="adminAssignTo"><option value="all">All Students</option></select></label>
      <button class="btn" id="adminAddAssign">Create Assignment</button>
    </div>

    <!-- Student XP Control -->
    <div class="card" style="min-width:320px">
      <h4>Students & XP</h4>
      <div id="adminStudentsList" style="max-height:280px;overflow:auto"></div>
    </div>

    <!-- Teacher Created Items -->
    <div class="card" style="min-width:320px">
      <h4>Your Created Items</h4>
      <div id="adminCreatedList" style="max-height:280px;overflow:auto"></div>
    </div>

  </div>
</div>

        </div>

        <div class="card page" id="signup" style="display:none;max-width:520px;margin:12px auto">
          <h3>Create a new account</h3>
          <input id="signupName" placeholder="Full Name" type="text">
          <input id="signupEmail" placeholder="Email" type="email">
          <input id="signupPass" placeholder="Password" type="password">
          <input id="signupCollege" placeholder="College / Institution Name" type="text">
          <select id="signupRoleClass" style="margin-top:8px">
            <option value="">Select Student Role/Class</option>
            <optgroup label="School">
              <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
              <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
              <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
            </optgroup>
            <optgroup label="B.Tech">
              <option>B.Tech 1st Year</option><option>B.Tech 2nd Year</option>
              <option>B.Tech 3rd Year</option><option>B.Tech 4th Year</option>
            </optgroup>
          </select>
          <select id="signupRoleClass" style="margin-top:8px">
  <option>Student</option>
  <option>Teacher</option>
</select>
          <input id="signupCode" placeholder="Invitation Code (if any)" type="text" style="margin-top:8px">
          <div id="signupError" style="color:#ff3333;margin-top:8px"></div>
          <div id="signupSuccess" style="color:#33ff33;margin-top:8px"></div>
          <div class="hint" style="margin-top:8px">By signing up, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.</div>
        

          <div style="margin-top:10px"><button class="btn" id="signupBtn">Sign Up</button></div>
          <div class="hint" style="margin-top:8px">Already have an account? <a href="#" id="toLogin">Login here</a></div>
        </div>

        <div class="card page" id="profile" style="display:none;max-width:720px;margin:12px auto">
          <h3>Profile <span id="adminBadge"></span></h3>
          <div style="display:flex;gap:12px;align-items:center">
            <div id="profilePhoto" style="width:96px;height:96px;border-radius:12px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center">No Photo</div>
            <div style="flex:1" class="profile-info">
              <div><div style="font-weight:700">Name: <span id="profileName"></span></div><div class="hint">Email: <span id="profileEmail"></span></div></div>
              <div><div class="hint">College/Inst: <strong id="profileCollege"></strong></div><div class="hint">Role/Class: <strong id="profileRoleClass"></strong></div></div>

              <input id="photoFile" type="file" accept="image/*" style="margin-top:8px">
              <button class="btn" id="uploadPhoto">Upload Photo</button>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px;">
            <button class="btn" id="toSchedule">Go to Schedule üìÖ</button>
            <button class="btn ghost" id="logoutBtn">Logout</button>
          </div>
        </div>

        <div class="page" id="home">
          <div class="grid">
            <div class="card">
              <h3>Welcome ‚Äî Smart Study Planner AI</h3>
              <p class="hint">AI-assisted planning, analytics, scheduler & chatbot ‚Äî all in one.</p>
            </div>

            <div class="card">
              <h3>Quick Add</h3>
              <div style="margin-top:8px" class="task-form">
                <input id="quickTitle" placeholder="Task title">
                <select id="quickSubject">
                  <option>General</option>
                  <option>Math</option>
                  <option>Physics</option>
                  <option>CS</option>
                  <option>COA</option>
                  <option>DS</option>
                  <option>HTML</option>
                  <option>PYTHON</option>
                  <option>C LANGUAGE</option>
                </select>
                <button class="btn" id="quickAddBtn">Add</button>
              </div>
            </div>

            <div class="card" style="padding:14px;margin-bottom:10px">
  <h3>‚è≥ Study Timer</h3>
  <div id="timerDisplay" style="font-size:28px;font-weight:800;margin:10px 0">00:00:00</div>
  <div style="display:flex;gap:10px">
    <button class="btn" id="timerStart">Start</button>
    <button class="btn ghost" id="timerPause">Pause</button>
    <button class="btn ghost" id="timerReset">Reset</button>
  </div>
</div>

            <div class="card">
              <h3>Today's Snapshot</h3>
              <canvas id="miniChart" style="height:120px"></canvas>
            </div>
            <div id="userLevelDisplay" style="font-size:20px;font-weight:700">
  Level: 1 ‚Ä¢ XP: 0
</div>


            <div class="card" style="grid-column:span 3">
              <h3>Weekly Highlights</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
                <div style="flex:1;min-width:180px" class="card"><strong>Streak</strong><div class="hint" id="streak">0 days</div></div>
                <div style="flex:1;min-width:180px" class="card"><strong>Top Subject</strong><div class="hint" id="topSub">‚Äî</div></div>
                <div style="flex:1;min-width:180px" class="card"><strong>Focus Window</strong><div class="hint">Evenings</div></div>
              </div>
            </div>
          </div>
        </div>
        


        <div class="page card" id="tasks" style="display:none">
          <h3>Tasks</h3>
          <div class="task-form">
            <input id="taskTitle" placeholder="Task title">
            <select id="taskSubject">
              <option>General</option><option>COA</option><option>DS</option><option>CS</option><option>PYTHON</option><option>C LANGUAGE</option><option>UHVP</option>
            </select>
            <input id="taskDue" type="date">
            <button class="btn" id="addTask">Add Task</button>
          </div>
          <div class="task-list" id="taskList"></div>
        </div>

        <div class="page card" id="goals" style="display:none">
          <h3>Goals</h3>
          <div class="task-form">
            <input id="goalName" placeholder="Goal name">
            <select id="goalSubject"><option>General</option><option>Math</option><option>Physics</option><option>CS</option><option>DS</option><option>COA</option><option>HTML</option><option>PYTHON</option></select>
            <input id="goalDate" type="date">
            <button class="btn" id="addGoal">Add</button>
          </div>
          <div id="goalList" style="margin-top:12px"></div>
          <div style="margin-top:10px"><button class="btn" id="genGoals">AI Suggest Goals</button></div>
        </div>

        <div class="page card" id="assignments" style="display:none">
          <h3>Assignments</h3>
          <div class="task-form">
            <input id="assignSubject" placeholder="Subject">
            <input id="assignDue" type="date">
            <input id="assignDesc" placeholder="Short description">
            <button class="btn" id="addAssign">Add</button>
          </div>
          <div id="assignList" style="margin-top:12px"></div>
        </div>

        <div class="page card" id="schedule" style="display:none">
          <h3>Weekly Schedule - Time Blocking</h3>
          <div style="display:flex;gap:12px;align-items:center">
            <div class="hint"> Drag tasks from the Tasks list below, or click AI Suggest for a time-blocked study plan.</div>
            <button class="btn" id="suggestTimes">AI Suggest Performance-Based Schedule</button>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>

        <div class="page card" id="analytics" style="display:none">
          <h3>Analytics</h3>
          <div class="grid">
            <div class="card"><h4>Study Hours (Weekly)</h4><canvas id="hoursChart" style="height:180px"></canvas></div>
            <div class="card"><h4>Completion Rate</h4><canvas id="rateChart" style="height:180px"></canvas></div>
            <div class="card"><h4>AI Insights</h4><div id="aiInsights" class="hint" style="margin-top:8px"></div></div>
          </div>
        </div>

        <div class="page card" id="chatbot" style="display:none">
          <h3>Chatbot</h3>
          <p class="hint">Try: "Suggest a study plan for finals" or any knowledge question.</p>
          <div class="chat-window" id="chatInline" style="display:flex;flex-direction:column;overflow:hidden">
            <div class="chat-header"><strong>StudyBot</strong></div>
            <div class="chat-body" id="chatBodyInline"></div>
            <div class="chat-input">
              <input id="chatInputInline" placeholder="Ask StudyBot...">
              <button class="btn" id="chatSendInline">Send</button>
            </div>
          </div>
        </div>

        <div class="page card" id="notes" style="display:none">
          <h3>Notes Repository</h3>
          <p class="hint">Search, upload and share notes.</p>

          <div class="notes-controls">
            <select id="noteClass" style="flex:1;min-width:160px">
              <option value="">Select Class/Year</option>
              <option>Class 1</option><option>Class 2</option>
              <option>Class 3</option><option>Class 4</option>
              <option>Class 5</option><option>Class 6</option>
              <option>Class 7</option><option>Class 8</option>
              <option>Class 9</option><option>Class 10</option>
              <option>Class 11</option><option>Class 12</option>
              <option>B.Tech 1st Year</option><option>B.Tech 2nd Year</option>
              <option>B.Tech 3rd Year</option><option>B.Tech 4th Year</option>
            </select>

            <select id="noteSubject" style="flex:1;min-width:160px">
              <option value="">Select Subject</option>
              <option>Math</option><option>Physics</option><option>Chemistry</option>
              <option>Biology</option><option>English</option>
              <option>Computer Science</option>
              <option>General</option>
            </select>

            <input id="searchNotes" placeholder="Search notes..." style="flex:1;min-width:200px" />
          </div>

          <div class="task-form" style="margin-top:12px">
            <input id="noteTitle" placeholder="Note title" />
            <textarea id="noteText" placeholder="Write your notes here..." rows="4"></textarea>
            <input id="noteFile" type="file" accept="image/*,.pdf" />
            <button class="btn" id="addNote">Upload Note</button>
          </div>

          <div id="notesList" style="margin-top:16px; display:flex; flex-direction:column; gap:12px"></div>
        </div>

        <div class="page" id="test-page" style="display:none">
          <h2>üß† AI Test Generator: Convert Notes to Questions</h2>
          <p class="hint">Upload your notes/chapter, verify the important topics identified by the AI, and instantly generate a question-wise test.</p>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">

            <div class="card">
              <h3>1. Upload/Paste Study Material</h3>
              <div class="task-form" style="display:flex; flex-direction:column; gap:8px;">
                <input id="testTitle" placeholder="Chapter/Unit Name (e.g., 'Thermodynamics')" />
                <select id="testSubject">
                  <option value="">Select Subject</option>
                  <option>General</option>
                  <option>Math</option>
                  <option>Physics</option>
                  <option>CS</option>
                  <option>COA</option>
                  <option>DS</option>
                  <option>HTML</option>
                  <option>PYTHON</option>
                  <option>C LANGUAGE</option>
                </select>
                <textarea id="testText" placeholder="Paste your study notes here..." rows="6"></textarea>
                <input id="testFile" type="file" accept="image/*,.pdf,.txt" />
                <button class="btn" id="generateTestBtn">Analyze & Identify Important Topics</button>
              </div>
            </div>

            <div class="card" id="verificationCard">
              <h3>2. Verify Important Topics (User-AI Loop)</h3>
              <p class="hint">AI identified **3** core topics. Click on any topic to **un-verify** it. Only verified topics will be used for question generation.</p>
              <div id="aiTopics" style="margin-top:10px;">
                <div class="topic-item-verify" data-topic-id="1">Topic: **The First Law of Thermodynamics** <button class="btn small" style="background:#5cb85c; padding: 4px 8px;">Verified</button></div>
                <div class="topic-item-verify" data-topic-id="2">Topic: **Heat Engines and Refrigerators** <button class="btn small" style="background:#5cb85c; padding: 4px 8px;">Verified</button></div>
                <div class="topic-item-verify" data-topic-id="3">Topic: **Entropy and the Second Law** <button class="btn small" style="background:#5cb85c; padding: 4px 8px;">Verified</button></div>
                <p class="hint small" style="margin-top:10px;">*Sample topics shown. Click "Analyze" (Step 1) to load real topics.*</p>
              </div>
              <button class="btn" id="finalizeTopicsBtn" style="margin-top:12px;">Finalize Topics & Generate Questions</button>
            </div>

            <div class="card" style="grid-column: span 2;">
              <h3>3. AI-Generated Test: Questions by Topic</h3>
              <p class="hint">These **question-wise** problems cover the important topics you verified. Self-test and track your performance.</p>
              <div id="testQuestions" style="margin-top:10px; max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                <p class="hint" style="text-align: center; padding: 10px;">Questions will appear here after topic analysis and verification.</p>
              </div>
            </div>

            <div class="card" style="grid-column: span 2;">
              <h3>4. Smart Study Planner Update</h3>
              <p class="hint">The AI suggests an immediate **Revision Task** based on this test and tracks this material as a new **Study Resource**.</p>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding: 10px; border-radius: 8px; background: rgba(0, 0, 0, 0.2);">
                <strong>Suggested Task:</strong> **Revision: [Chapter Name] Test** (Suggested Time: 45 mins)
                <button class="btn" id="addStudyTask">Add to Tasks & Schedule</button>
              </div>
              <p class="hint small" style="margin-top:8px;">*Successfully generating a test tracks it as a key resource. Use the <a href="#" onclick="showPage('analytics')">Analytics</a> tab to review performance on these topics.</p>
            </div>

          </div>
        </div>

      </section>

      <div class="footer">Built with ‚Äî B.TECHLY &nbsp;&nbsp; Owner ‚Äî SHIVAM KUMAR JHA</div>
    </main>
  </div>

  <button class="chat-btn" id="openChatBtn">üí¨</button>

  <div class="chat-window" id="chatPopup">
    <div class="chat-header">
      <strong>StudyBot</strong>
      <button class="btn ghost" id="closeChat">‚úï</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Ask StudyBot...">
      <button class="btn" id="chatSend">Send</button>
    </div>
  </div>

  <script>
  // ---------- STORAGE & STATE ----------
  let chats = {}; // chats[uid1][uid2] = [{sender, text, time}]


  const STORAGE_KEYS = { STATE:'ssp_state_v2', AUTH:'ssp_auth_v2' };
  // Make one global STATE object that stores notes, tasks, goals, assignments, calendar
  let STATE = { notes:[], tasks:[], goals:[], assigns:[], calendar:{} };

  function saveState(){ try{ localStorage.setItem(STORAGE_KEYS.STATE, JSON.stringify(STATE)); }catch(e){ console.warn('saveState failed',e); } }
  function loadState(){ try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEYS.STATE)||'null'); if(s) STATE = Object.assign({}, STATE, s); }catch(e){ console.warn('loadState failed',e); } }
  loadState();

  // small DOM helper
  const $ = id => document.getElementById(id);

  // escape
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  
// GLOBAL STUDY TIMER
// -------------------------
let timerInterval = null;
let totalSeconds = 0;

function updateTimerUI() {
  const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
  const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
  const secs = String(totalSeconds % 60).padStart(2, '0');
  const disp = document.getElementById("timerDisplay");
  if (disp) disp.innerText = `${hrs}:${mins}:${secs}`;
}

document.getElementById("timerStart")?.addEventListener("click", () => {
  if (timerInterval) return; // already running
  timerInterval = setInterval(() => {
    totalSeconds++;
    updateTimerUI();
  }, 1000);
});

document.getElementById("timerPause")?.addEventListener("click", () => {
  clearInterval(timerInterval);
  timerInterval = null;
});

document.getElementById("timerReset")?.addEventListener("click", () => {
  clearInterval(timerInterval);
  timerInterval = null;
  totalSeconds = 0;
  updateTimerUI();
});


  // ---------- NAVIGATION ----------
  function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
    // mark active nav
    document.querySelectorAll('#nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===id));
    // scroll top
    window.scrollTo({top:0,behavior:'smooth'});
  }
  function calculateLevel(xp){
  if(xp < 100) return 1;
  if(xp < 250) return 2;
  if(xp < 500) return 3;
  if(xp < 900) return 4;
  return 5;
}

  function updateUserLevelUI(){
  if(!CURRENT_USER) return;
  const box = document.getElementById("userLevelDisplay");
  if(box) box.innerText = `Level: ${calculateLevel(CURRENT_USER.xp||0)} ‚Ä¢ XP: ${CURRENT_USER.xp||0}`;
  if(CURRENT_USER.role === "Teacher"){
    document.getElementById("navAdmin").style.display = "block";
  }
}
  function awardXpTo(uidTarget, amount){
  const u = STATE.users.find(x=>x.uid === uidTarget);
  if(!u) return;
  u.xp = (u.xp || 0) + Number(amount);
  saveState();
  if(CURRENT_USER && CURRENT_USER.uid === uidTarget){
    CURRENT_USER = u;
    saveAuthLocal(u);
    updateUserLevelUI();
  }
  updateUserLevelUI();
}



  // wire nav buttons (defensive: only if present)
  document.querySelectorAll('#nav button').forEach(b=>{
    b.addEventListener('click', ()=> {
      const page = b.dataset.page;
      if(page) showPage(page);
    });
  });
  $('navLogin')?.addEventListener('click', ()=> showPage('login'));
  $('navSignup')?.addEventListener('click', ()=> showPage('signup'));
  $('navProfile')?.addEventListener('click', ()=> showPage('profile'));
  $('toSchedule')?.addEventListener('click', ()=> showPage('schedule')); // NEW LINK FROM PROFILE

  // default show home
  showPage('home');

  // quick internal links
  $('toSignup')?.addEventListener('click', (e)=>{ e.preventDefault(); showPage('signup'); });
  $('toLogin')?.addEventListener('click', (e)=>{ e.preventDefault(); showPage('login'); });

  // ---------- RENDER & HELPERS ----------
  function safe(fn){ try{ fn(); }catch(e){ console.warn('error in safe call',e); } }

  // ---------- TASKS ----------
  function renderTasks(){
    safe(()=>{
      const list = $('taskList');
      if(!list) return;
      list.innerHTML = '';
      STATE.tasks.forEach((t,i)=>{
        const item = document.createElement('div');
        item.className = 'task-item' + (t.done? ' done':'');
        item.innerHTML = `<div><strong>${escapeHtml(t.title)}</strong><div class="hint small">${escapeHtml(t.subject)} ‚Ä¢ ${t.due||'no due'}</div></div>
          <div>
            <input type='checkbox' data-idx='${i}' ${t.done? 'checked':''}>
            <button class='btn ghost' data-del='${i}'>Delete</button>
          </div>`;
        list.appendChild(item);
      });
      // attach listeners
      list.querySelectorAll('input[type=checkbox]').forEach(ch=>{
        ch.addEventListener('change', e=>{
          const i = parseInt(e.target.dataset.idx);
          STATE.tasks[i].done = e.target.checked;
          saveState(); renderTasks(); updateCharts(); renderCalendar(); renderNotes(); renderAssignments();
        });
      });
      list.querySelectorAll('[data-del]').forEach(bt=>{
        bt.addEventListener('click', e=>{
          const i = parseInt(e.target.dataset.del);
          STATE.tasks.splice(i,1);
          saveState(); renderTasks(); updateCharts(); renderCalendar(); renderNotes(); renderAssignments();
        });
      });
      // make tasks draggable by index
      Array.from(list.children).forEach((ti, idx)=>{
        ti.setAttribute('draggable','true');
        ti.addEventListener('dragstart', ev => ev.dataTransfer.setData('text/plain', idx));
      });
    });
  }


  // add task
  $('addTask')?.addEventListener('click', ()=>{
    const title = $('taskTitle').value.trim();
    if(!title) return alert('Enter title');
    const subject = $('taskSubject').value;
    const due = $('taskDue').value || null;
    STATE.tasks.push({title, subject, due, done:false, created:Date.now()});
    saveState();
    $('taskTitle').value=''; $('taskDue').value='';
    renderTasks(); updateCharts(); renderCalendar();
  });

  $('quickAddBtn')?.addEventListener('click', ()=>{
    const t = $('quickTitle').value.trim();
    if(!t) return;
    STATE.tasks.push({title:t, subject:$('quickSubject').value, done:false, created:Date.now()});
    saveState(); renderTasks(); updateCharts(); renderCalendar();
    $('quickTitle').value='';
  });

  // ---------- ASSIGNMENTS ----------
  function renderAssignments(){
    safe(()=>{
      const el = $('assignList'); if(!el) return;
      el.innerHTML = '';
      STATE.assigns.forEach((a,i)=>{
        const div = document.createElement('div'); div.className='card note-card'; div.style.marginTop='8px';
        div.innerHTML = `<strong>${escapeHtml(a.subject)}</strong><div class="hint small">${escapeHtml(a.desc)} ‚Ä¢ ${a.due||'no due'}</div>
          <div style="margin-top:6px"><button class="btn ghost" data-del="${i}">Delete</button></div>`;
        el.appendChild(div);
      });
      el.querySelectorAll('[data-del]').forEach(bt=>{
        bt.addEventListener('click', e=>{
          const i = parseInt(e.target.dataset.del);
          STATE.assigns.splice(i,1); saveState(); renderAssignments();
        });
      });
    });
  }

  $('addAssign')?.addEventListener('click', ()=>{
    const s = $('assignSubject').value.trim(); if(!s) return alert('Enter subject');
    STATE.assigns.push({subject:s, due: $('assignDue').value || null, desc: $('assignDesc').value || ''});
    saveState(); renderAssignments(); $('assignSubject').value=''; $('assignDesc').value=''; $('assignDue').value='';
  });

  // ---------- GOALS ----------
  function renderGoals(){
    safe(()=>{
      const el = $('goalList'); if(!el) return;
      el.innerHTML='';
      STATE.goals.forEach((g,i)=>{
        const d = document.createElement('div'); d.className='card'; d.style.marginTop='8px';
        d.innerHTML = `<strong>${escapeHtml(g.name)}</strong><div class="hint small">${escapeHtml(g.subject)} ‚Ä¢ target ${g.target||'‚Äî'}</div>
          <div style="margin-top:6px"><div style="height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden">
            <div style="height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:${g.progress||0}%"></div></div></div>`;
        el.appendChild(d);
      });
    });
  }

  $('addGoal')?.addEventListener('click', ()=>{
    const name = $('goalName').value.trim(); if(!name) return alert('Enter goal');
    STATE.goals.push({name, subject:$('goalSubject').value, target:$('goalDate').value || null, progress:0});
    saveState(); renderGoals(); $('goalName').value=''; $('goalDate').value='';
  });

  $('genGoals')?.addEventListener('click', ()=>{
    // simple generation based on tasks
    const subjCount = {}; STATE.tasks.forEach(t=> subjCount[t.subject] = (subjCount[t.subject]||0) + 1);
    const top = Object.entries(subjCount).sort((a,b)=>b[1]-a[1])[0];
    const generated = [];
    if(top) generated.push({name:`Deepen ${top[0]} understanding`, subject:top[0], target: new Date(Date.now()+1000*60*60*24*21).toISOString().slice(0,10), progress:5});
    generated.push({name:'Complete 90 min daily review', subject:'General', target:new Date(Date.now()+1000*60*60*24*14).toISOString().slice(0,10), progress:3});
    STATE.goals = STATE.goals.concat(generated);
    saveState(); renderGoals(); alert('AI suggested '+generated.length+' goals');
  });

  // ---------- CALENDAR / SCHEDULE (UPDATED LOGIC) ----------
  const weekDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  function renderCalendar(){
    safe(()=>{
      const el = $('calendar'); if(!el) return;
      el.innerHTML = '';
      for(let i=0;i<7;i++){
        const d = document.createElement('div'); d.className='day'; d.dataset.day = i;
        d.innerHTML = `<h4>${weekDays[i]}</h4><div class='slot' id='slot-${i}'></div>`;
        el.appendChild(d);
      }
      // drop zones
      document.querySelectorAll('.day').forEach(dd=>{
        dd.addEventListener('dragover', e=> e.preventDefault());
        dd.addEventListener('drop', e=>{
          e.preventDefault();
          const idx = e.dataTransfer.getData('text/plain');
          const t = STATE.tasks[idx];
          if(!t) return;
          const slot = $('slot-'+dd.dataset.day);
          const el2 = document.createElement('div'); el2.className='draggable'; el2.innerText = t.title;
          slot.appendChild(el2);
        });
      });
    });
  }
  renderCalendar();

  // AI Suggest Performance-Based Structured Blocks (UPDATED FUNCTION)
  $('suggestTimes')?.addEventListener('click', ()=>{
    document.querySelectorAll('.slot').forEach(s=>s.innerHTML='');
    let msg = 'AI suggested a time-blocked study schedule based on best practices.';

    // 1. Determine User Role for high-level structuring
    const userRole = CURRENT_USER?.roleClass || 'General Student';
    const userName = CURRENT_USER?.name || 'Student';

    // 2. Determine Weakest Subject (based on pending tasks/assignments)
    const subjectLoad = {};
    STATE.tasks.filter(t => !t.done).forEach(t => subjectLoad[t.subject] = (subjectLoad[t.subject] || 0) + 1);
    STATE.assigns.forEach(a => subjectLoad[a.subject] = (subjectLoad[a.subject] || 0) + 2); // Assignments weigh more
    const sortedSubjects = Object.entries(subjectLoad).sort((a, b) => b[1] - a[1]);
    const weakestSubject = sortedSubjects.length > 0 ? sortedSubjects[0][0] : 'General';
    const highestLoad = sortedSubjects.length > 0 ? sortedSubjects[0][1] : 0;
    const totalPending = STATE.tasks.filter(t => !t.done).length + STATE.assigns.length;
    const pendingGoals = STATE.goals.length;

    // Logic for block scheduling
    const scheduleBlocks = [];

    // Block 1: Weakness/High Load Focus (Monday)
    if (highestLoad > 0) {
        scheduleBlocks.push({ day: 0, title: `Deep Focus: ${weakestSubject} (120m) - Identified Weakness`, subject: weakestSubject }); // Monday
        msg += ` Your current biggest area of focus is ${weakestSubject} (Load: ${highestLoad}).`;
    } else {
        scheduleBlocks.push({ day: 0, title: "Deep Focus: Core Subject (120m)", subject: "General" });
    }

    // Block 2: Assignment/Goal Work (Tuesday/Wednesday)
    if (STATE.assigns.length > 0 || pendingGoals > 0) {
        scheduleBlocks.push({ day: 2, title: `Work on ${STATE.assigns.length} Assignments & ${pendingGoals} Goals (90m)`, subject: "General" });
    } else {
        scheduleBlocks.push({ day: 2, title: "Review Strongest Subject (60m)", subject: "General" });
    }

    // Block 3: Role-Based Core Study (Thursday/Friday)
    if (userRole.includes('Class')) {
        scheduleBlocks.push({ day: 4, title: `Role Focus: Math/Science Prep (90m) - ${userRole}`, subject: "Math/Physics" });
    } else if (userRole.includes('B.Tech')) {
        scheduleBlocks.push({ day: 4, title: `Role Focus: Project/Tech Work (90m) - ${userRole}`, subject: "CS/COA" });
    } else {
         scheduleBlocks.push({ day: 4, title: "General Knowledge/Skill Building (60m)", subject: "General" });
    }

    // Block 4: Quick Task Review (Tuesday)
    scheduleBlocks.push({ day: 1, title: `Quick Review of ${totalPending} Pending Tasks (60m)`, subject: "General" });

    // Block 5: Weekend Planning/Self-Care
    scheduleBlocks.push({ day: 5, title: `Weekly Review & Planning for Next Week (90m)`, subject: "General" });
    scheduleBlocks.push({ day: 6, title: "Self-Care & Light Reading (30m)", subject: "General" });

    // Render the new blocks
    scheduleBlocks.forEach(block => {
        const slot = $('slot-'+block.day);
        if (slot) {
            const el2 = document.createElement('div');
            el2.className = 'draggable';
            el2.style.background = block.subject === weakestSubject ? '#FF5733' : (block.subject === 'General' ? 'rgba(255, 255, 255, 0.2)' : 'linear-gradient(90deg,var(--accent1),var(--accent2))');
            el2.innerText = `[AI Block] ${block.title}`;
            slot.appendChild(el2);
        }
    });

    alert(msg + `\n\nGenerated schedule for ${userName} (${userRole}) focusing on key demands. Drag your tasks into these blocks.`);
  });

  // ---------- CHARTS ----------
  let miniChart=null, hoursChart=null, rateChart=null;
  function setupCharts(){
    safe(()=>{
      const miniCtx = $('miniChart')?.getContext('2d');
      if(miniCtx) miniChart = new Chart(miniCtx,{type:'doughnut',data:{labels:['Done','Left'],datasets:[{data:[1,4]}]},options:{plugins:{legend:{display:false}}}});
      const hoursCtx = $('hoursChart')?.getContext('2d');
      if(hoursCtx) hoursChart = new Chart(hoursCtx,{type:'bar',data:{labels:weekDays,datasets:[{label:'Hours',data:[1,2,1,3,2,0,2]}]},options:{responsive:true}});
      const rateCtx = $('rateChart')?.getContext('2d');
      if(rateCtx) rateChart = new Chart(rateCtx,{type:'pie',data:{labels:['Completed','Pending'],datasets:[{data:[2,5]}]},options:{plugins:{legend:{position:'bottom'}}}});
    });
  }
  setupCharts();

  function updateCharts(){
    safe(()=>{
      const completed = STATE.tasks.filter(t=>t.done).length;
      const total = STATE.tasks.length || 1;
      const rate = Math.round((completed/total)*100);
      if(miniChart){
        miniChart.data.datasets[0].data = [Math.round(rate/10), 10-Math.round(rate/10)];
        miniChart.update();
      }
      if(hoursChart){ hoursChart.data.datasets[0].data = Array.from({length:7}, ()=>Math.floor(Math.random()*3)); hoursChart.update(); }
      if(rateChart){ rateChart.data.datasets[0].data = [rate,100-rate]; rateChart.update(); }
      $('aiInsights') && ($('aiInsights').innerHTML = `<div class='hint'>AI Insight: Completion rate ${rate}%. Best time: evenings (6‚Äì9pm). Current Focus: **${CURRENT_USER?.roleClass || 'Student'}**</div>`);
    });
  }
  updateCharts();

  // ---------- NOTES FEATURE ----------
  function renderNotes(){
    safe(()=>{
      const list = $('notesList'); if(!list) return;
      const q = ($('searchNotes')?.value || '').toLowerCase();
      const subj = $('noteSubject')?.value || '';
      const cls = $('noteClass')?.value || '';
      list.innerHTML = '';

      STATE.notes
        .filter(n => (!subj || n.subject === subj))
        .filter(n => (!cls || n.class === cls))
        .filter(n => (!q || (n.title||'').toLowerCase().includes(q) || (n.text||'').toLowerCase().includes(q)))
        .forEach((n,i) => {
          const div = document.createElement('div');
          div.className = 'card note-card';
          const fileButton = n.fileURL ? `<a href='${n.fileURL}' target='_blank' class='btn ghost small' style='margin-top:8px'>View File</a>` : '';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>${escapeHtml(n.title)}</strong>
              <div class="small hint">Class/Year: ${escapeHtml(n.class || '')} ‚Ä¢ Subject: ${escapeHtml(n.subject || '')}</div>
            </div>
            <div class='hint small' style='margin-top:8px'>${escapeHtml(n.text || '')}</div>
            <div style='margin-top:8px'>${fileButton}
              <button class='btn ghost small' data-del='${i}' style='margin-left:8px'>Delete</button>
            </div>`;
          list.appendChild(div);
        });

      list.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = parseInt(e.target.dataset.del);
          if(isNaN(id)) return;
          if(!confirm('Delete this note?')) return;
          STATE.notes.splice(id,1);
          saveState();
          renderNotes();
        });
      });
    });
  }

  // add note handler
  $('addNote')?.addEventListener('click', ()=>{
    const title = ($('noteTitle')?.value || '').trim();
    const text = ($('noteText')?.value || '').trim();
    const subj = ($('noteSubject')?.value || '').trim();
    const cls = ($('noteClass')?.value || '').trim();
    const fileInput = $('noteFile');
    if(!title || !subj || !cls) return alert('Fill title, class/year, and subject');

    const file = fileInput?.files?.[0];
    if(file){
      const reader = new FileReader();
      reader.onload = () => {
        const fileURL = reader.result; // Data URL (base64)
        STATE.notes.push({title, text, subject:subj, class:cls, fileURL, created:Date.now()});
        saveState(); renderNotes(); // clear fields
        $('noteTitle').value=''; $('noteText').value=''; if(fileInput) fileInput.value='';
      };
      reader.readAsDataURL(file);
    } else {
      STATE.notes.push({title, text, subject:subj, class:cls, fileURL:null, created:Date.now()});
      saveState(); renderNotes();
      $('noteTitle').value=''; $('noteText').value=''; if(fileInput) fileInput.value='';
    }
  });

  // filters & search wiring
  ['searchNotes','noteSubject','noteClass'].forEach(id=>{
    if($(id)) $(id).addEventListener('input', ()=> renderNotes());
  });

  // ---------- CHAT BOT ----------
  function appendChat(el, text, who='bot'){
    if(!el) return;
    const b = document.createElement('div'); b.className = 'bubble ' + (who==='user'? 'user':'bot'); b.innerText = text;
    el.appendChild(b); el.scrollTop = el.scrollHeight;
  }

 // The ADVANCED botReply function: Updated to handle general questions
  function botReply(message, el){
    if(!message) return appendChat(el, "Ask me anything! I can help with study planning, progress, or general knowledge.");
    message = message.toLowerCase();
    
    // --- 1. Study-Planner & Motivation Functions (Priority) ---
    
    // Planner: Study Plan
    if(message.includes('study plan')) {
        return appendChat(el,"Here's a high-level 7-day study plan: prioritize weakest subjects, use 90-min focused sessions with 15-min breaks (Pomodoro is highly effective), and conduct a nightly review. What subject are you focused on?");
    }
    
    // Planner: Progress/Summary
    if(message.includes('summarize') || message.includes('progress')){ 
        const comp = STATE.tasks.filter(t=>t.done).length; 
        return appendChat(el, `Your current progress is: ${comp}/${STATE.tasks.length} tasks completed this week.`); 
    }
    
    // Motivation
    if(message.includes('motivate')){ 
        const quotes=['Small steps lead to big changes.','Consistency beats intensity.','Study smart, rest well.','Believe you can, and you are halfway there.']; 
        return appendChat(el, quotes[Math.floor(Math.random()*quotes.length)]); 
    }

    // --- 2. Advanced General/Knowledge Q&A Simulation (Fulfills 'any question') ---

    // Heuristic: Check if the query is a likely general knowledge question or a complex, detailed question
    const knowledgeKeywords = ['what is', 'how does', 'tell me about', 'define', 'who is', 'when did', 'why is'];
    const isKnowledgeQuery = knowledgeKeywords.some(keyword => message.includes(keyword));

    if (isKnowledgeQuery || message.length > 40) { 
        // Simulated response for a general or complex knowledge question, framed as an AI model response.
        const generalTip = Math.random() < 0.5 ? "A powerful learning principle is **Spaced Repetition**, which involves reviewing information at increasing intervals to boost long-term retention." : "For effective note-taking, try the **Cornell System** (Cue, Notes, Summary sections) to organize and review information easily.";
        return appendChat(el, `[Knowledge Synthesis Mode] Query: "${message}". I can retrieve detailed information on this, but since I am running locally as a StudyBot, my core focus remains on advanced cognitive strategies. ${generalTip} How can I assist with your study technique for this topic?`);
    }
    
    // --- 3. General Study Tip Fallback (for non-hardcoded study queries) ---
    const tips = [
        "Try **Active Recall**‚Äîquizzing yourself is one of the most effective ways to move information into long-term memory.",
        "Implement the **Feynman Technique**: teach the concept to someone else to quickly identify and close gaps in your understanding.",
        "Ensure you take **intentional breaks** every hour to maintain focus and boost retention.",
        "**Switching up your study environment** can unexpectedly improve your recall performance."
    ];
    return appendChat(el, tips[Math.floor(Math.random()*tips.length)] + " What else can I help you plan or learn today?");
  }

  $('chatSend')?.addEventListener('click', ()=>{
    const m = ($('chatInput')?.value || '').trim(); if(!m) return;
    appendChat($('chatBody'), m, 'user'); $('chatInput').value='';
    setTimeout(()=> botReply(m, $('chatBody')), 600);
  });

  $('openChatBtn')?.addEventListener('click', ()=>{ $('chatPopup').style.display='flex'; $('openChatBtn').style.display='none'; });
  $('closeChat')?.addEventListener('click', ()=>{ $('chatPopup').style.display='none'; $('openChatBtn').style.display='flex'; });

  $('chatSendInline')?.addEventListener('click', ()=>{
    const m = ($('chatInputInline')?.value || '').trim(); if(!m) return;
    appendChat($('chatBodyInline'), m, 'user'); $('chatInputInline').value=''; setTimeout(()=> botReply(m, $('chatBodyInline')), 600);
  });

  // #######################################################
  // AI TEST PAGE LOGIC (Kept from previous update)
  // #######################################################

  // Simulated topics data

  const topics = [
    "Quantum Mechanics",
    "Machine Learning",
    "Genetic Algorithms",
    "Neural Networks",
    "Cognitive Psychology",
    "Information Theory",
    "Operating Systems",
    "Computer Architecture"
  ];
/*
  Advanced Test Page Integration
  - Uses existing DOM IDs from your study14.html (testTitle, testText, testFile, testSubject, generateTestBtn, aiTopics, finalizeTopicsBtn, testQuestions, addStudyTask)
  - Attempts to call /api/analyze (POST) with form-data (text + file + mode). If that fails, uses simulateAnalysis().
  - Produces strict JSON output format as specified by the prompt.
*/

// Utility: escape for safe innerHTML
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Prepare payload for AI model or simulation
function buildAnalysisPayload({title, subject, text, file, mode}) {
  // mode: 'notes' or 'exam'
  // Build a minimal context for backend model so it can run the prompt
  return {
    prompt_meta: "Smart Study Planner AI ‚Äî advanced exam-focused analysis",
    mode,
    title,
    subject,
    text,
    filename: file ? file.name : null,
    timestamp: new Date().toISOString()
  };
}

// Attempt to call backend AI API. If not available, fallback to simulateAnalysis().
async function callBackendOrSimulate(formData) {
  try {
    // Try backend endpoint - replace '/api/analyze' with your real serverless / backend route
    const resp = await fetch('/api/analyze', { method: 'POST', body: formData, timeout: 30000 });
    if(!resp.ok) throw new Error('Backend responded with ' + resp.status);
    const json = await resp.json();
    // Expect the strict JSON output - if missing, fallback to simulation
    if(json && json.detected_subject) return json;
    throw new Error('Invalid backend response');
  } catch (err) {
    // console.warn('Backend call failed, falling back to simulation:', err);
    // build payload from formData for simulation
    const payload = {};
    for (const pair of formData.entries()) payload[pair[0]] = pair[1];
    return simulateAnalysis(payload);
  }
}

// Simple deterministic simulator that produces the required JSON shape.
// You can extend this to include more realistic NLP heuristics or call a local model.
function simulateAnalysis(payload) {
  const title = payload.title || 'Untitled Chapter';
  const subject = payload.subject || 'General';
  const text = (payload.text || '').slice(0,2000);
  const mode = payload.mode || (payload.filename ? 'exam' : 'notes');

  // heuristic weak topics extraction: look for keywords in text
  const keywords = [
    'theorem','definition','proof','derivation','entropy','thermodynamics','ohm','integration','derivative','matrix','transformer','rms'
  ];
  const found = [];
  for(const k of keywords){
    if(text.toLowerCase().includes(k) && found.length < 6) found.push(k.charAt(0).toUpperCase() + k.slice(1));
  }
  // fallback topics
  if(found.length===0) found.push(`${subject} Core Concepts`, 'Important Formulae', 'Typical Problem Types');

  // Build "important topics" (5 items max)
  const important_topics = found.slice(0,5).map((t,i) => ({
    topic: t + (i===0 && title ? ` ‚Äî ${title}` : ''),
    reason: `High exam relevance / appears in the uploaded content or typical syllabus (${t}).`,
    verified: true
  }));

  // Weak topics if exam mode
  const weak_topics = mode === 'exam' ? important_topics.slice(0,3).map(t => t.topic) : [];

  // Create 3 qns per topic (1 conceptual, 1 application, 1 numerical) with answers
  const generated_questions = [];
  const answers = [];
  important_topics.forEach((T, idx) => {
    const base = T.topic;
    const qset = [];
    // conceptual
    qset.push({ q: `Explain the core idea of ${base}.`, difficulty: 'Easy', type: 'conceptual' });
    answers.push({ question: qset[qset.length-1].q, answer_short: `Short: Key idea of ${base}.`, answer_long: `Long: Detailed explanation of ${base} with step-by-step elaboration and common pitfalls.` });
    // application
    qset.push({ q: `Describe one practical application of ${base} and how it is used in problems.`, difficulty: 'Moderate', type: 'application' });
    answers.push({ question: qset[qset.length-1].q, answer_short: `Short: Application example of ${base}.`, answer_long: `Long: Describe the real-world or exam application, key steps to solve such problems, and tips.` });
    // numerical / problem
    qset.push({ q: `Solve a typical numerical problem related to ${base}. (Show steps)`, difficulty: 'Hard', type: 'numerical' });
    answers.push({ question: qset[qset.length-1].q, answer_short: `Short: Numerical answer for ${base} problem.`, answer_long: `Long: Step-by-step solution with formulas, intermediate steps, and final result.` });

    generated_questions.push({ topic: base, questions: qset });
  });

  // improvement plan: simple scaffold
  const improvement_plan = `Revision plan for ${title}: Focus first on ${important_topics[0].topic}. Use 45‚Äì60 min focused session, do 3 practice problems, and review mistakes for 15 minutes. Repeat daily for 7 days.`;
  const study_block = { title: `Revision: ${title}`, duration_min: 50, recommended_when: 'Evening (6‚Äì8pm)' };

  const suggested_tasks = [
    { title: `Revision: ${title} Test`, subject, duration_min: 50, due: null },
  ];

  // performance summary heuristic
  const performance_summary = mode === 'exam' ? 'Weak ‚Äî frequent conceptual mistakes detected' : 'Average ‚Äî requires focused revision';

  // strict output
  const output = {
    detected_subject: subject,
    detected_chapter: title,
    performance_summary,
    weak_topics,
    important_topics,
    verified_topics: important_topics.filter(t => t.verified).map(t => t.topic),
    generated_questions,
    answers,
    improvement_plan,
    suggested_tasks,
    study_block
  };

  return output;
}

// Render results into the Test Page UI
function renderAnalysisResult(result) {
  // Update AI Topics panel using important_topics
  const aiTopicsEl = document.getElementById('aiTopics');
  if(aiTopicsEl){
    aiTopicsEl.innerHTML = '';
    result.important_topics.forEach((t, i)=>{
      const item = document.createElement('div');
      item.className = 'topic-item-verify' + (t.verified ? '' : ' unverified');
      item.dataset.topicId = String(i);
      item.innerHTML = `Topic: <strong>${esc(t.topic)}</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="hint small" style="max-width:320px">${esc(t.reason)}</div>
          <button class="btn small" data-idx="${i}" style="padding:4px 8px">${t.verified ? 'Verified' : 'Unverified'}</button>
        </div>`;
      aiTopicsEl.appendChild(item);
      // Toggle verification on click
      item.addEventListener('click', ()=> {
        t.verified = !t.verified;
        // also update verified_topics list in result for internal logic
        result.verified_topics = result.important_topics.filter(pp => pp.verified).map(pp => pp.topic);
        renderAnalysisResult(result);
      });
    });
  }

  // Render Questions
  const qEl = document.getElementById('testQuestions');
  if(qEl){
    qEl.innerHTML = '';
    result.generated_questions.forEach((g, gi)=>{
      const sec = document.createElement('div');
      sec.style.borderTop = '1px solid rgba(255,255,255,0.08)';
      sec.style.padding = '8px';
      sec.innerHTML = `<strong style="display:block">${esc(g.topic)}</strong>`;
      g.questions.forEach((q, qi)=>{
        const idx = gi*10 + qi + 1;
        const qdiv = document.createElement('div');
        qdiv.style.padding = '8px 0';
        qdiv.innerHTML = `<div><strong>Q${idx} (${esc(q.difficulty)})</strong>: ${esc(q.q)}</div>
                          <div class="hint small" style="margin-top:6px">Answer (short): ${esc(result.answers[gi*3+qi].answer_short)}</div>
                          <details style="margin-top:6px"><summary class="hint small">Show long answer</summary><div style="padding:8px">${esc(result.answers[gi*3+qi].answer_long)}</div></details>`;
        sec.appendChild(qdiv);
      });
      qEl.appendChild(sec);
    });

    // Add download JSON button
    const dl = document.createElement('div');
    dl.style.textAlign = 'center';
    dl.style.marginTop = '10px';
    dl.innerHTML = `<button class="btn ghost" id="downloadTestJson">Download Test (JSON)</button>`;
    qEl.appendChild(dl);
    document.getElementById('downloadTestJson')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(result, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${result.detected_chapter || 'test'}-test.json`; a.click();
      URL.revokeObjectURL(url);
    });
  }

  // Show improvement plan and suggested study block (we'll reuse the "4. Smart Study Planner Update" area)
  const plannerArea = document.querySelector('#test-page .card[style*="grid-column: span 2;"]');
  if(plannerArea){
    // find the "4. Smart Study Planner Update" card by heading
    const cards = document.querySelectorAll('#test-page .card');
    // We'll append a small summary area inside the last big card (4)
    const summaryEl = document.createElement('div');
    summaryEl.style.marginTop = '10px';
    summaryEl.style.padding = '10px';
    summaryEl.style.background = 'rgba(255,255,255,0.02)';
    summaryEl.innerHTML = `<strong>Improvement Plan:</strong>
      <div class="hint small" style="margin-top:6px">${esc(result.improvement_plan)}</div>
      <div style="margin-top:8px"><strong>Suggested study block:</strong> ${esc(result.study_block.title || '')} ‚Äî ${esc(String(result.study_block.duration_min || ''))} min</div>
      <div style="margin-top:8px"><strong>Performance Summary:</strong> ${esc(result.performance_summary)}</div>`;
    // Place into the existing 4th card (find by heading text)
    const allCards = Array.from(document.querySelectorAll('#test-page .card'));
    const target = allCards.find(c => c.querySelector('h3') && c.querySelector('h3').innerText && c.querySelector('h3').innerText.includes('Smart Study Planner Update'));
    if(target){
      // remove any previous summary block
      const prev = target.querySelector('.analysis-summary');
      if(prev) prev.remove();
      const wrapper = document.createElement('div');
      wrapper.className = 'analysis-summary';
      wrapper.appendChild(summaryEl);
      target.appendChild(wrapper);
    }
  }
}

// Event: Analyze & Identify Important Topics (override previous behavior)
document.getElementById('generateTestBtn')?.addEventListener('click', async () => {
  const title = (document.getElementById('testTitle')?.value || '').trim() || 'Untitled Chapter';
  const subject = document.getElementById('testSubject')?.value || 'General';
  const text = (document.getElementById('testText')?.value || '').trim();
  const fileInput = document.getElementById('testFile');
  const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  const mode = file ? 'exam' : (text.length < 60 ? 'notes' : 'notes');

  if(!text && !file){
    return alert('Please paste notes or upload a file (PDF/image/text).');
  }

  // Show quick feedback
  alert(`Analyzing "${title}" (${subject}) ‚Äî mode: ${mode}. This may take a moment.`);

  // Build formData
  const formData = new FormData();
  formData.append('title', title);
  formData.append('subject', subject);
  formData.append('text', text);
  formData.append('mode', mode);
  if(file) formData.append('file', file);

  // Call backend or simulate
  const result = await callBackendOrSimulate(formData);

  // Ensure strict keys exist
  const requiredKeys = ["detected_subject","detected_chapter","performance_summary","weak_topics","important_topics","verified_topics","generated_questions","answers","improvement_plan","suggested_tasks","study_block"];
  for(const k of requiredKeys) if(!(k in result)) result[k] = (k === 'important_topics' || k === 'weak_topics' || k === 'generated_questions' || k === 'answers' || k === 'verified_topics' || k === 'suggested_tasks') ? [] : '';

  // Render
  renderAnalysisResult(result);

  // Save current simulated result to window so finalize button can use it
  window.__LAST_ANALYSIS_RESULT = result;
});

// Event: Finalize topics & generate full test (uses window.__LAST_ANALYSIS_RESULT)
document.getElementById('finalizeTopicsBtn')?.addEventListener('click', () => {
  const result = window.__LAST_ANALYSIS_RESULT;
  if(!result) return alert('Please analyze a chapter first (Step 1).');
  // Use only verified topics
  const verified = result.important_topics.filter(t => t.verified);
  if(verified.length === 0) return alert('Please verify at least one topic to generate questions.');

  // Filter generated_questions by verified topics
  const filteredQuestions = result.generated_questions.filter(g => verified.some(v => v.topic === g.topic));
  const filteredAnswers = [];
  // Rebuild answers array matching filteredQuestions (best-effort mapping by question text)
  filteredQuestions.forEach((g, gi)=>{
    g.questions.forEach((q, qi)=>{
      const ans = result.answers.find(a => a.question && a.question.includes(q.q.split(' ').slice(0,5).join(' '))) || {question:q.q, answer_short:'Short answer', answer_long:'Long answer'};
      filteredAnswers.push(ans);
    });
  });

  // Build final object to present as the 'test' (strict format)
  const finalTest = {
    detected_subject: result.detected_subject,
    detected_chapter: result.detected_chapter,
    performance_summary: result.performance_summary,
    weak_topics: result.weak_topics,
    important_topics: result.important_topics,
    verified_topics: verified.map(v => v.topic),
    generated_questions: filteredQuestions,
    answers: filteredAnswers,
    improvement_plan: result.improvement_plan,
    suggested_tasks: result.suggested_tasks,
    study_block: result.study_block
  };

  // Render final test JSON inside testQuestions area
  const qEl = document.getElementById('testQuestions');
  if(qEl){
    qEl.innerHTML = `<pre style="white-space:pre-wrap; max-height:400px; overflow:auto; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px;">${esc(JSON.stringify(finalTest, null, 2))}</pre>
      <div style="text-align:center; margin-top:8px"><button class="btn" id="downloadFinalJson">Download Final Test (JSON)</button></div>`;
    document.getElementById('downloadFinalJson')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(finalTest, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${finalTest.detected_chapter || 'final-test'}.json`; a.click();
      URL.revokeObjectURL(url);
    });
  }

  // Save to window for planner integration
  window.__LAST_FINAL_TEST = finalTest;

  alert('Questions generated from verified topics. You can download the JSON or add the suggested revision task to your Planner.');
});

// Event: Add suggested study task to Planner (re-uses existing addStudyTask but integrates result)
document.getElementById('addStudyTask')?.addEventListener('click', () => {
  const finalTest = window.__LAST_FINAL_TEST || window.__LAST_ANALYSIS_RESULT;
  if(!finalTest) return alert('Please generate a test first.');

  // Use the first suggested task or create one
  const suggested = (finalTest.suggested_tasks && finalTest.suggested_tasks[0]) || { title: `Revision: ${finalTest.detected_chapter} Test`, subject: finalTest.detected_subject, duration_min: (finalTest.study_block && finalTest.study_block.duration_min) || 45 };

  // Add to STATE.tasks (STATE exists in original HTML; this integrates seamlessly)
  if(window.STATE && Array.isArray(window.STATE.tasks)){
    window.STATE.tasks.push({ title: suggested.title, subject: suggested.subject || 'General', done: false, created: Date.now(), duration_min: suggested.duration_min || suggested.duration_min, due: null });
    try{ window.saveState && window.saveState(); }catch(e){}
    // Re-render tasks/calendar if functions exist
    try{ window.renderTasks && window.renderTasks(); window.renderCalendar && window.renderCalendar(); window.updateCharts && window.updateCharts(); }catch(e){}
    alert(`Added revision task: "${suggested.title}" to Tasks.`);
  } else {
    alert('Planner not available in this context. (STATE not found).');
  }
});


  // Step 1: Analyze & Identify Important Topics
  $('generateTestBtn')?.addEventListener('click', () => {
    const title = $('testTitle')?.value || 'Untitled Chapter';
    const notesText = $('testText')?.value.trim();
    if (!title || (!notesText && !$('testFile')?.files?.[0])) {
        return alert('Please provide a Chapter/Unit name and either paste notes or upload a file.');
    }
    alert(`AI is analyzing "${title}" for important topics... (This is where the AI processes the notes/file).`);

    // Simulate AI identifying topics and requiring user verification
    renderAITopics(SIMULATED_TOPICS, title);

    // Placeholder questions removed until Step 3
    $('testQuestions').innerHTML = `<p class="hint" style="text-align: center; padding: 10px;">Topics analyzed. Please proceed to Step 2: Verification.</p>`;
  });

  // Step 3: Finalize Topics & Generate Questions
  $('finalizeTopicsBtn')?.addEventListener('click', () => {
      const verifiedTopics = SIMULATED_TOPICS.filter(t => t.verified);
      const questionsEl = $('testQuestions');

      if (verifiedTopics.length === 0) {
          return alert('Please verify at least one topic to generate questions.');
      }

      alert(`Topics finalized: ${verifiedTopics.map(t => t.name).join(', ')}. AI is generating ${verifiedTopics.length * 3} question-wise test problems now...`);

      // Simulate Question Generation based on verified topics
      const generatedQuestions = verifiedTopics.map((topic, index) => {
          return `
              <div style="padding:10px; border-top:1px solid rgba(255,255,255,0.1);">
                  <strong>Q${index * 3 + 1}:</strong> Define the core principle of ${topic.name.toLowerCase()}. <span class="small hint">(Topic: ${topic.name})</span>
              </div>
              <div style="padding:10px; border-top:1px solid rgba(255,255,255,0.1);">
                  <strong>Q${index * 3 + 2}:</strong> Provide a short answer on the practical application of ${topic.name.toLowerCase()}. <span class="small hint">(Topic: ${topic.name})</span>
              </div>
              <div style="padding:10px; border-top:1px solid rgba(255,255,255,0.1);">
                  <strong>Q${index * 3 + 3}:</strong> Write a numerical problem related to ${topic.name.toLowerCase()}. <span class="small hint">(Topic: ${topic.name})</span>
              </div>
          `;
      }).join('');

      if(questionsEl) {
          questionsEl.innerHTML = generatedQuestions + `
              <div style="text-align:center; padding:10px; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1);">
                  <button class="btn ghost">Download Test (PDF)</button>
              </div>`;
      }

      // Step 4: Smart Planner Update Alert
      alert('Test generated successfully! A new revision task has been suggested in your Planner (Step 4).');
  });

  // Step 4: Smart Study Planner Update - Add Task
  $('addStudyTask')?.addEventListener('click', () => {
    const chapterName = $('testTitle')?.value || 'AI Generated Test';
    const subject = $('testSubject')?.value || 'General';
    const taskTitle = `Revision: ${chapterName} Test`;

    if (!chapterName || chapterName === 'Untitled Chapter') return alert('Please analyze a chapter first.');

    // Add task to global state
    STATE.tasks.push({title: taskTitle, subject: subject, done:false, created:Date.now(), due: null});
    saveState();
    // Re-render relevant components to show the update
    renderTasks();
    renderCalendar();
    updateCharts();

    alert(`"${taskTitle}" added to Tasks and suggested to your Schedule!`);
  });

  // ---------- AUTH (demo local only) ----------
  let CURRENT_USER = null;
  function saveAuthLocal(u){ localStorage.setItem(STORAGE_KEYS.AUTH, JSON.stringify(u)); }
  function loadAuthLocal(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.AUTH)||'null'); }

  // UPDATED updateProfileUI
  function updateProfileUI(){
    if(!CURRENT_USER){
      if($('profileName')) $('profileName').innerText='Guest';
      if($('profileEmail')) $('profileEmail').innerText='';
      if($('profileCollege')) $('profileCollege').innerText='N/A';
      if($('profileRoleClass')) $('profileRoleClass').innerText='N/A';
      if($('roleDisplay')) $('roleDisplay').innerText='Guest';
      if($('avatar')) $('avatar').innerText='S';
      if($('adminBadge')) $('adminBadge').innerHTML='';
      return;
    }
    if($('profileName')) $('profileName').innerText = CURRENT_USER.name || '';
    if($('profileEmail')) $('profileEmail').innerText = CURRENT_USER.email || '';
    if($('profileCollege')) $('profileCollege').innerText = CURRENT_USER.college || 'N/A';
    if($('profileRoleClass')) $('profileRoleClass').innerText = CURRENT_USER.roleClass || 'N/A';
    if($('roleDisplay')) $('roleDisplay').innerText = CURRENT_USER.roleClass || 'Student';
    if($('avatar')) $('avatar').innerText = CURRENT_USER.name? CURRENT_USER.name.charAt(0).toUpperCase():'U';
    if(CURRENT_USER.role === 'Admin') $('adminBadge').innerHTML = '<span class="admin-badge">ADMIN</span>'; else $('adminBadge').innerHTML='';
  }

  // UPDATED signupBtn
  $('signupBtn')?.addEventListener('click', ()=>{
    const name = ($('signupName')?.value || '').trim();
    const email = ($('signupEmail')?.value || '').trim();
    const pass = ($('signupPass')?.value || '').trim();
    const college = ($('signupCollege')?.value || '').trim();
    const roleClass = ($('signupRoleClass')?.value || '').trim();

    if(!name || !email || !pass || !roleClass) return alert('Fill all required fields: Name, Email, Password, and select your Role/Class.');

    CURRENT_USER = { uid: ''+Date.now(), name, email, role:'Student', college, roleClass };
    saveAuthLocal(CURRENT_USER); updateProfileUI(); alert('Account created (demo). Please login.');
    showPage('login');
  });

  $('loginBtn')?.addEventListener('click', ()=>{
    const email = ($('loginEmail')?.value || '').trim();
    const pass = ($('loginPass')?.value || '').trim();
    if(!email || !pass) return alert('Enter credentials');
    const demo = loadAuthLocal();
    if(!demo || demo.email !== email) return alert('Invalid demo credentials. Use the account you created in demo mode.');
    CURRENT_USER = demo; saveAuthLocal(CURRENT_USER); updateProfileUI(); showPage('profile'); alert('Logged in (demo)');
  });

  $('logoutBtn')?.addEventListener('click', ()=>{ CURRENT_USER = null; saveAuthLocal(null); updateProfileUI(); showPage('home'); alert('Signed out'); });

  // Profile photo upload (demo only)
  $('uploadPhoto')?.addEventListener('click', ()=>{
    const f = $('photoFile')?.files?.[0]; if(!f) return alert('Choose a file');
    const reader = new FileReader();
    reader.onload = () => {
      const url = reader.result;
      if(CURRENT_USER){ CURRENT_USER.photoURL = url; saveAuthLocal(CURRENT_USER); updateProfileUI(); alert('Photo uploaded (demo)'); }
      else alert('No user logged in');
    };
    reader.readAsDataURL(f);
  });

  // ---------- INITIAL RENDERS ----------
  updateProfileUI(); // Check if a user is already logged in from previous session
  renderTasks(); renderGoals(); renderAssigns(); renderAssignments(); renderNotes(); updateCharts();

  // ensure charts & calendar update after initial state load
  window.addEventListener('load', ()=>{ renderCalendar(); updateCharts(); renderNotes(); renderTasks(); renderAssignments(); });
  // -------------------------

// let STATE = {
//   users: [],     // {uid, name, email, role:'Student'|'Teacher', xp:0}
//   tasks: [],     // {title, subject, level, xpReward, createdBy, assignedTo, completedBy}
//   goals: [],
//   assigns: [],   // {title, subject, due, xpReward, createdBy, assignedTo, completedBy}
//   notes: []
// };
// Function to calculate level based on XP
function calculateLevel(xp) {
    return Math.floor(0.1 * Math.sqrt(xp));
}
// Function to save state to localStorage
function saveState() {
    localStorage.setItem('studyPlannerState', JSON.stringify(STATE));
}

// Load state from localStorage on page load
loadState();

function loadState() {
    const savedState = localStorage.getItem('studyPlannerState');
    if (savedState) {
        STATE = JSON.parse(savedState);
    }
}
function renderAdminStudents(){
  const el = document.getElementById("adminStudentsList");
  if(!el) return;
  el.innerHTML = "";

  STATE.users.forEach(u=>{
    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${u.name}</strong>
          <div class="small hint">
            ${u.email} ‚Ä¢ Role: ${u.role} ‚Ä¢ XP: ${u.xp || 0} ‚Ä¢ Level: ${calculateLevel(u.xp || 0)}
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <input type="number" placeholder="XP" class="xpInput" data-uid="${u.uid}" style="width:80px">
          <button class="btn small" data-uid="${u.uid}" data-action="addXp">Give XP</button>
        </div>
      </div>
      <div class="small hint" style="margin-top:4px">
        ${u.role === 'Student' ? 'Student' : 'Teacher'}
      </div>
      
    `;
    el.appendChild(div);
  });

  el.querySelectorAll('[data-action="addXp"]').forEach(btn=>{
    btn.addEventListener("click",()=>{
      const uid = btn.dataset.uid;
      const input = el.querySelector(`.xpInput[data-uid='${uid}']`);
      const xp = Number(input.value || 0);
      if(xp <= 0) return alert("Enter XP");

      awardXpTo(uid, xp);
      renderAdminStudents();
      alert("XP added!");
    });
  });
}
function awardXpTo(uid, xp){
  const user = STATE.users.find(u=>u.uid===uid);
  if(user){
    user.xp = (user.xp || 0) + xp;
    saveState();
    renderUserProfile();
    renderAdminStudents();
    renderAssignments();
    renderNotes();

  }
}

function ensureChat(userA, userB){
  if(!STATE.chats[userA]) STATE.chats[userA] = {};
  if(!STATE.chats[userA][userB]) STATE.chats[userA][userB] = [];
}

function sendMessage(toUID, msg){
  const from = CURRENT_USER.uid;
  ensureChat(from, toUID);
  ensureChat(toUID, from);

  const packet = {
    sender: from,
    text: msg,
    time: new Date().toLocaleTimeString()
  };

  STATE.chats[from][toUID].push(packet);
  STATE.chats[toUID][from].push(packet);

  saveState();
  loadMessages(toUID);
  renderChatUsers();
}

function loadMessages(uid){
  const box = document.getElementById("chatMessages");
  const header = document.getElementById("chatHeader");
  header.innerText = "Chat with " + (STATE.users.find(x=>x.uid===uid)?.name || "Unknown");

  ensureChat(CURRENT_USER.uid, uid);
  const msgs = STATE.chats[CURRENT_USER.uid][uid];

  box.innerHTML = "";
  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.style.margin = "6px 0";
    div.innerHTML = `
      <div style="font-size:12px" class="hint">${m.sender === CURRENT_USER.uid ? "You" : "Them"} ‚Ä¢ ${m.time}</div>
      <div style="padding:6px;background:${m.sender===CURRENT_USER.uid ? "rgba(0,150,255,0.5)" : "rgba(255,255,255,0.1)"};border-radius:6px">${m.text}</div>
    `;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

function renderChatUsers(){
  const list = document.getElementById("chatUserList");
  list.innerHTML = "";

  STATE.users.forEach(u=>{
    if(u.uid === CURRENT_USER.uid) return;

    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.cursor = "pointer";
    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    div.innerText = u.name;

    div.addEventListener("click", ()=>{
      CURRENT_CHAT_TARGET = u.uid;
      loadMessages(u.uid);
    });

    list.appendChild(div);
  });
}

function ensureChat(userA, userB){
  if(!STATE.chats[userA]) STATE.chats[userA] = {};
  if(!STATE.chats[userA][userB]) STATE.chats[userA][userB] = [];
}

function sendMessage(toUID, msg){
  const from = CURRENT_USER.uid;
  ensureChat(from, toUID);
  ensureChat(toUID, from);

  const packet = {
    sender: from,
    text: msg,
    time: new Date().toLocaleTimeString()
  };

  STATE.chats[from][toUID].push(packet);
  STATE.chats[toUID][from].push(packet);

  saveState();
  loadMessages(toUID);
  renderChatUsers();
}

function loadMessages(uid){
  const box = document.getElementById("chatMessages");
  const header = document.getElementById("chatHeader");
  header.innerText = "Chat with " + (STATE.users.find(x=>x.uid===uid)?.name || "Unknown");

  ensureChat(CURRENT_USER.uid, uid);
  const msgs = STATE.chats[CURRENT_USER.uid][uid];

  box.innerHTML = "";
  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.style.margin = "6px 0";
    div.innerHTML = `
      <div style="font-size:12px" class="hint">${m.sender === CURRENT_USER.uid ? "You" : "Them"} ‚Ä¢ ${m.time}</div>
      <div style="padding:6px;background:${m.sender===CURRENT_USER.uid ? "rgba(0,150,255,0.5)" : "rgba(255,255,255,0.1)"};border-radius:6px">${m.text}</div>
    `;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}
 function ensureChat(userA, userB){
  if(!STATE.chats[userA]) STATE.chats[userA] = {};
  if(!STATE.chats[userA][userB]) STATE.chats[userA][userB] = [];
}

function sendMessage(toUID, msg){
  const from = CURRENT_USER.uid;
  ensureChat(from, toUID);
  ensureChat(toUID, from);

  const packet = {
    sender: from,
    text: msg,
    time: new Date().toLocaleTimeString()
  };

  STATE.chats[from][toUID].push(packet);
  STATE.chats[toUID][from].push(packet);

  saveState();
  loadMessages(toUID);
  renderChatUsers();
}

function loadMessages(uid){
  const box = document.getElementById("chatMessages");
  const header = document.getElementById("chatHeader");
  header.innerText = "Chat with " + (STATE.users.find(x=>x.uid===uid)?.name || "Unknown");

  ensureChat(CURRENT_USER.uid, uid);
  const msgs = STATE.chats[CURRENT_USER.uid][uid];

  box.innerHTML = "";
  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.style.margin = "6px 0";
    div.innerHTML = `
      <div style="font-size:12px" class="hint">${m.sender === CURRENT_USER.uid ? "You" : "Them"} ‚Ä¢ ${m.time}</div>
      <div style="padding:6px;background:${m.sender===CURRENT_USER.uid ? "rgba(0,150,255,0.5)" : "rgba(255,255,255,0.1)"};border-radius:6px">${m.text}</div>
    `;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

function renderChatUsers(){
  const list = document.getElementById("chatUserList");
  list.innerHTML = "";

  STATE.users.forEach(u=>{
    if(u.uid === CURRENT_USER.uid) return;

    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.cursor = "pointer";
    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    div.innerText = u.name;

    div.addEventListener("click", ()=>{
      CURRENT_CHAT_TARGET = u.uid;
      loadMessages(u.uid);
    });

    list.appendChild(div);
  });
}

function ensureChat(userA, userB){
  if(!STATE.chats[userA]) STATE.chats[userA] = {};
  if(!STATE.chats[userA][userB]) STATE.chats[userA][userB] = [];
}

function sendMessage(toUID, msg){
  const from = CURRENT_USER.uid;
  ensureChat(from, toUID);
  ensureChat(toUID, from);

  const packet = {
    sender: from,
    text: msg,
    time: new Date().toLocaleTimeString()
  };

  STATE.chats[from][toUID].push(packet);
  STATE.chats[toUID][from].push(packet);

  saveState();
  loadMessages(toUID);
  renderChatUsers();
}

function loadMessages(uid){
  const box = document.getElementById("chatMessages");
  const header = document.getElementById("chatHeader");
  header.innerText = "Chat with " + (STATE.users.find(x=>x.uid===uid)?.name || "Unknown");

  ensureChat(CURRENT_USER.uid, uid);
  const msgs = STATE.chats[CURRENT_USER.uid][uid];

  box.innerHTML = "";
  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.style.margin = "6px 0";
    div.innerHTML = `
      <div style="font-size:12px" class="hint">${m.sender === CURRENT_USER.uid ? "You" : "Them"} ‚Ä¢ ${m.time}</div>
      <div style="padding:6px;background:${m.sender===CURRENT_USER.uid ? "rgba(0,150,255,0.5)" : "rgba(255,255,255,0.1)"};border-radius:6px">${m.text}</div>
    `;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

function checkReminders(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  STATE.assigns.forEach(a=>{
    if(a.due === today){
      sendReminder(a);
    }
  });
}

function sendReminder(assign){
  const text = `Reminder:\nAssignment: ${assign.title}\nDue Today!\nXP: ${assign.xpReward}`;

  // WhatsApp reminder
  const waURL = `https://wa.me/?text=${encodeURIComponent(text)}`;

  // Email reminder
  const emailURL = `mailto:?subject=Assignment%20Reminder&body=${encodeURIComponent(text)}`;

  alert("Sending reminders...");

  window.open(waURL, "_blank");
  window.open(emailURL, "_blank");
}


function checkReminders(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  STATE.assigns.forEach(a=>{
    if(a.due === today){
      sendReminder(a);
    }
  });
}

function sendReminder(assign){
  const text = `Reminder:\nAssignment: ${assign.title}\nDue Today!\nXP: ${assign.xpReward}`;

  // WhatsApp reminder
  const waURL = `https://wa.me/?text=${encodeURIComponent(text)}`;

  // Email reminder
  const emailURL = `mailto:?subject=Assignment%20Reminder&body=${encodeURIComponent(text)}`;

  alert("Sending reminders...");

  window.open(waURL, "_blank");
  window.open(emailURL, "_blank");
}

function checkReminders(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  STATE.assigns.forEach(a=>{
    if(a.due === today){
      sendReminder(a);
    }
  });
}

setInterval(checkReminders, 30000);

function sendMessage(target, text){
  const msg = {
    sender: CURRENT_USER.uid,
    text,
    timestamp: Date.now()
  };

  STATE.messages[target] = STATE.messages[target] || [];
  STATE.messages[target].push(msg);

  saveState();
  loadMessages(target);
}

function awardXpTo(uid, xp){
  const u = STATE.users.find(x=>x.uid===uid);
  if(!u) return;

  const oldLevel = calculateLevel(u.xp || 0);

  u.xp = (u.xp || 0) + Number(xp);

  const newLevel = calculateLevel(u.xp);

  if(newLevel > oldLevel){
    sendLevelUpNotification(u, newLevel);
  }

  saveState();
}
function sendLevelUpNotification(student, level){
  const msg = `üéâ Congrats ${student.name}! You reached Level ${level}. Keep going!`;

  const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  const mail = `mailto:${student.email}?subject=Level%20Up!&body=${encodeURIComponent(msg)}`;

  alert("Sending level-up notification...");
  window.open(wa, "_blank");
  window.open(mail, "_blank");
}

function loadMessages(target){
  const list = document.getElementById("chatMessages");
  list.innerHTML = "";

  const messages = STATE.messages[target] || [];

  messages.forEach(m=>{
    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";

    const sender = STATE.users.find(x=>x.uid===m.sender);
    div.innerHTML = `<b>${sender.name}</b>: ${m.text}`;

    list.appendChild(div);
  });
}
document.getElementById("sendChatBtn").addEventListener("click", ()=>{
  const text = document.getElementById("chatInput").value.trim();
  if(!text || !CURRENT_CHAT_TARGET) return;
  sendMessage(CURRENT_CHAT_TARGET, text);
  document.getElementById("chatInput").value = "";
});

let CURRENT_CHAT_TARGET = null;

function renderChatUsers(){
  const list = document.getElementById("chatUserList");
  list.innerHTML = "";

  STATE.users.forEach(u=>{
    if(u.uid === CURRENT_USER.uid) return;

    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.cursor = "pointer";
    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    div.innerText = u.name;

    div.addEventListener("click", ()=>{
      CURRENT_CHAT_TARGET = u.uid;
      loadMessages(u.uid);
    });

    list.appendChild(div);
  });
}

</script>

</body>
</html>
